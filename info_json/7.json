{
  "id": 7,
  "repo": "neon",
  "issue_url": "https://github.com/neondatabase/neon/issues/7723",
  "pr_url": "https://github.com/neondatabase/neon/pull/7915",
  "issue_description": "We don't carry `run-*` labels from external contributors PRs to `ci-run/pr-*` PRs. This is not really convenient.\r\nNeed to sync labels in `approved-for-ci-run` workflow.\r\n\r\n              Merging main and doing a CI run to get benchmarks run in https://github.com/neondatabase/neon/pull/7717 (I've added a label to that PR)\r\n\r\n_Originally posted by @bayandin in https://github.com/neondatabase/neon/issues/7242#issuecomment-2107115847_\r\n            ",
  "files_changed": [
    {
      "filename": ".github/workflows/approved-for-ci-run.yml",
      "status": "modified",
      "patch": "@@ -69,15 +69,41 @@ jobs:\n         with:\n           ref: main\n           token: ${{ secrets.CI_ACCESS_TOKEN }}\n+      \n+      - name: Look for existing PR\n+        id: get-pr\n+        env:\n+          GH_TOKEN: ${{ secrets.CI_ACCESS_TOKEN }}\n+        run: |\n+          ALREADY_CREATED=\"$(gh pr --repo ${GITHUB_REPOSITORY} list --head ${BRANCH} --base main --json number --jq '.[].number')\"\n+          echo \"ALREADY_CREATED=${ALREADY_CREATED}\" >> ${GITHUB_OUTPUT}\n+      \n+      - name: Get changed labels\n+        id: get-labels\n+        if: steps.get-pr.outputs.ALREADY_CREATED != ''\n+        env:\n+          ALREADY_CREATED: ${{ steps.get-pr.outputs.ALREADY_CREATED }}\n+          GH_TOKEN: ${{ secrets.CI_ACCESS_TOKEN }}\n+        run: |\n+          LABELS_TO_REMOVE=$(comm -23 <(gh pr --repo ${GITHUB_REPOSITORY} view ${ALREADY_CREATED} --json labels --jq '.labels.[].name'| ( grep -E '^run' || true ) | sort) \\\n+          <(gh pr --repo ${GITHUB_REPOSITORY} view ${PR_NUMBER} --json labels --jq '.labels.[].name' | ( grep -E '^run' || true ) | sort ) |\\\n+          ( grep -v run-e2e-tests-in-draft || true ) | paste -sd , -)\n+          LABELS_TO_ADD=$(comm -13 <(gh pr --repo ${GITHUB_REPOSITORY} view ${ALREADY_CREATED} --json labels --jq '.labels.[].name'| ( grep -E '^run' || true ) |sort) \\\n+          <(gh pr --repo ${GITHUB_REPOSITORY} view ${PR_NUMBER} --json labels --jq '.labels.[].name' |  ( grep -E '^run' || true ) | sort ) |\\\n+          paste -sd , -)\n+          echo \"LABELS_TO_ADD=${LABELS_TO_ADD}\" >> ${GITHUB_OUTPUT}\n+          echo \"LABELS_TO_REMOVE=${LABELS_TO_REMOVE}\" >> ${GITHUB_OUTPUT}\n \n       - run: gh pr checkout \"${PR_NUMBER}\"\n \n       - run: git checkout -b \"${BRANCH}\"\n \n       - run: git push --force origin \"${BRANCH}\"\n+        if: steps.get-pr.outputs.ALREADY_CREATED == ''\n \n       - name: Create a Pull Request for CI run (if required)\n-        env:\n+        if: steps.get-pr.outputs.ALREADY_CREATED == ''\n+        env: \n           GH_TOKEN: ${{ secrets.CI_ACCESS_TOKEN }}\n         run: |\n           cat << EOF > body.md\n@@ -88,16 +114,33 @@ jobs:\n             Feel free to review/comment/discuss the original PR #${PR_NUMBER}.\n           EOF\n \n-          ALREADY_CREATED=\"$(gh pr --repo ${GITHUB_REPOSITORY} list --head ${BRANCH} --base main --json number --jq '.[].number')\"\n-          if [ -z \"${ALREADY_CREATED}\" ]; then\n-            gh pr --repo \"${GITHUB_REPOSITORY}\" create --title \"CI run for PR #${PR_NUMBER}\" \\\n+          LABELS=$( (gh pr --repo \"${GITHUB_REPOSITORY}\" view ${PR_NUMBER}  --json labels --jq '.labels.[].name'; echo run-e2e-tests-in-draft  )| \\\n+          grep -E '^run' | paste -sd , -)\n+          gh pr --repo \"${GITHUB_REPOSITORY}\" create --title \"CI run for PR #${PR_NUMBER}\" \\\n                                                        --body-file \"body.md\" \\\n                                                        --head \"${BRANCH}\" \\\n                                                        --base \"main\" \\\n-                                                       --label \"run-e2e-tests-in-draft\" \\\n+                                                       --label ${LABELS} \\\n                                                        --draft\n+      - name: Modify the existing pull request (if required)\n+        if: steps.get-pr.outputs.ALREADY_CREATED != ''\n+        env:\n+          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}\n+          LABELS_TO_ADD: ${{ steps.get-labels.outputs.LABELS_TO_ADD }}\n+          LABELS_TO_REMOVE: ${{ steps.get-labels.outputs.LABELS_TO_REMOVE }}\n+          ALREADY_CREATED: ${{ steps.get-pr.outputs.ALREADY_CREATED }}\n+        run: |\n+          ADD_CMD=\n+          REMOVE_CMD=\n+          [ -z \"${LABELS_TO_ADD}\" ] || ADD_CMD=\"--add-label ${LABELS_TO_ADD}\"\n+          [ -z \"${LABELS_TO_REMOVE}\" ] || REMOVE_CMD=\"--remove-label ${LABELS_TO_REMOVE}\"\n+          if [ -n \"${ADD_CMD}\" ] || [ -n \"${REMOVE_CMD}\" ]; then\n+            gh pr --repo \"${GITHUB_REPOSITORY}\" edit ${ALREADY_CREATED} ${ADD_CMD} ${REMOVE_CMD}\n           fi\n \n+      - run: git push --force origin \"${BRANCH}\"\n+        if: steps.get-pr.outputs.ALREADY_CREATED != ''\n+             \n   cleanup:\n     # Close PRs and delete branchs if the original PR is closed.\n "
    }
  ],
  "fix_category": NaN,
  "root_cause_category": NaN,
  "root_cause_subcategory": "!Rust (CI)"
}